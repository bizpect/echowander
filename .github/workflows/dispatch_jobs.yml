name: Journey Dispatch Jobs Processor

# 스케줄: KST 기준 약 5분마다 실행 (UTC는 -9시간)
# 정각 혼잡 회피를 위해 오프셋 적용 (2, 7, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57분)
# GitHub Actions는 best-effort이므로 ±3분 오차 발생 가능
"on":
  schedule:
    # UTC 기준 2, 7, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57분
    - cron: '2-59/5 * * * *'

  # 수동 실행 지원 (디버깅/테스트용)
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Batch size for processing jobs'
        required: false
        default: '20'
        type: string

# 최소 권한 원칙: read-only
permissions:
  contents: read

jobs:
  process_dispatch_jobs:
    name: Process Journey Dispatch Jobs
    runs-on: ubuntu-latest

    steps:
      # Step 1: RPC로 job 상태 관리 + 매칭 수행
      - name: Call Supabase RPC (Job Management)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '20' }}
        run: |
          # 환경변수 검증
          if [ -z "$SUPABASE_URL" ]; then
            echo "ERROR: SUPABASE_URL is not set"
            exit 1
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "ERROR: SUPABASE_SERVICE_ROLE_KEY is not set"
            exit 1
          fi

          echo "=== Step 1: Calling process_journey_dispatch_jobs RPC ==="
          echo "Batch size: $BATCH_SIZE"

          # RPC 호출
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/process_journey_dispatch_jobs" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"p_batch\": ${BATCH_SIZE}}")

          # HTTP 상태 코드 확인
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: HTTP $HTTP_CODE"
            echo "Response (first 500 chars):"
            head -c 500 response.json
            exit 1
          fi

          echo "SUCCESS: HTTP $HTTP_CODE"
          echo "Response:"
          cat response.json

          # 정리
          rm -f response.json

      # Step 2: Edge Function 호출로 FCM 발송 + notification_logs 갱신
      - name: Call Edge Function (FCM Dispatch)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DISPATCH_JOB_SECRET: ${{ secrets.APP_DISPATCH_JOB_SECRET }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '20' }}
        run: |
          echo "=== Step 2: Calling dispatch_journey_matches Edge Function ==="
          echo "Batch size: $BATCH_SIZE"

          # Edge Function URL 구성
          EDGE_URL="${SUPABASE_URL}/functions/v1/dispatch_journey_matches"
          echo "Edge Function URL: $EDGE_URL"

          # 헤더 구성 (DISPATCH_JOB_SECRET이 있으면 추가)
          HEADERS="-H \"apikey: ${SUPABASE_SERVICE_ROLE_KEY}\" \
                   -H \"Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}\" \
                   -H \"Content-Type: application/json\""

          if [ -n "$DISPATCH_JOB_SECRET" ]; then
            HEADERS="$HEADERS -H \"x-dispatch-secret: ${DISPATCH_JOB_SECRET}\""
          fi

          # Edge Function 호출
          HTTP_CODE=$(curl -s -o edge_response.json -w "%{http_code}" \
            -X POST \
            "$EDGE_URL" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            ${DISPATCH_JOB_SECRET:+-H "x-dispatch-secret: ${DISPATCH_JOB_SECRET}"} \
            -d "{\"batch_size\": ${BATCH_SIZE}, \"complete_batch_size\": ${BATCH_SIZE}}")

          echo "Edge Function HTTP Code: $HTTP_CODE"

          # HTTP 상태 코드 확인
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Edge Function returned HTTP $HTTP_CODE"
            echo "Response:"
            cat edge_response.json
            # Edge Function 실패해도 전체 실패로 처리하지 않음 (best-effort)
            # RPC는 이미 성공했으므로 매칭은 완료됨
            echo "WARNING: FCM dispatch may have failed, but matching completed successfully"
          else
            echo "SUCCESS: Edge Function HTTP $HTTP_CODE"
            echo "Response:"
            cat edge_response.json
          fi

          # 정리
          rm -f edge_response.json
