name: Journey Dispatch Jobs Processor

# 스케줄: KST 기준 약 5분마다 실행 (UTC는 -9시간)
# 정각 혼잡 회피를 위해 오프셋 적용 (2, 7, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57분)
# GitHub Actions는 best-effort이므로 ±3분 오차 발생 가능
"on":
  schedule:
    # UTC 기준 2, 7, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57분
    - cron: '2-59/5 * * * *'

  # 수동 실행 지원 (디버깅/테스트용)
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Batch size for processing jobs'
        required: false
        default: '20'
        type: string

# 최소 권한 원칙: read-only
permissions:
  contents: read

jobs:
  process_dispatch_jobs:
    name: Process Journey Dispatch Jobs
    runs-on: ubuntu-latest

    steps:
      - name: Call Supabase RPC
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '20' }}
        run: |
          # 환경변수 검증
          if [ -z "$SUPABASE_URL" ]; then
            echo "ERROR: SUPABASE_URL is not set"
            exit 1
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "ERROR: SUPABASE_SERVICE_ROLE_KEY is not set"
            exit 1
          fi

          echo "Calling process_journey_dispatch_jobs RPC..."
          echo "Batch size: $BATCH_SIZE"

          # RPC 호출
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" \
            -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/process_journey_dispatch_jobs" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"p_batch\": ${BATCH_SIZE}}")

          # HTTP 상태 코드 확인
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: HTTP $HTTP_CODE"
            echo "Response (first 500 chars):"
            head -c 500 response.json
            exit 1
          fi

          echo "SUCCESS: HTTP $HTTP_CODE"
          echo "Response:"
          cat response.json

          # 정리
          rm -f response.json
